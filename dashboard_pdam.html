<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Evaluasi Cabang PDAM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .month-selector {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .month-selector label {
            font-weight: 600;
            color: #495057;
        }
        
        .month-selector select {
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }
        
        .month-selector select:hover {
            border-color: #667eea;
        }
        
        .month-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        .heatmap {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .heatmap-title {
            font-size: 1.3em;
            color: #2d3748;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .heatmap-grid {
            display: grid;
            gap: 2px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .heatmap-row {
            display: grid;
            grid-template-columns: 150px repeat(auto-fit, minmax(100px, 1fr));
            gap: 2px;
        }
        
        .heatmap-cell {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .heatmap-header {
            background: #495057;
            color: white;
            font-weight: 700;
        }
        
        .heatmap-label {
            background: #6c757d;
            color: white;
            text-align: left;
            padding-left: 15px;
        }
        
        .status-naik {
            background: #28a745;
            color: white;
        }
        
        .status-turun {
            background: #dc3545;
            color: white;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 5;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }
        
        .number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
        }
        
        @media (max-width: 768px) {
            .heatmap-container {
                grid-template-columns: 1fr;
            }
            
            .month-selector {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Dashboard Evaluasi Cabang PDAM</h1>
            <p>Analisis Perbandingan Data Bulanan dengan Visualisasi Heatmap</p>
        </div>
        
        <div class="controls">
            <div class="month-selector">
                <div>
                    <label for="bulan-sebelum">ðŸ“… Bulan Sebelumnya:</label>
                    <select id="bulan-sebelum"></select>
                </div>
                <div>
                    <label for="bulan-sekarang">ðŸ“… Bulan Sekarang:</label>
                    <select id="bulan-sekarang"></select>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                Silakan upload file Excel "Data Evaluasi Cabang PDAM.xlsx" ke folder yang sama dengan file HTML ini...
            </div>
            
            <div id="data-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">ðŸ“‹ Data Keseluruhan</h2>
                    <div class="table-container">
                        <table id="data-table">
                            <thead>
                                <tr>
                                    <th>Cabang</th>
                                    <th>Pelanggan</th>
                                    <th>Konsumsi Gol 2</th>
                                    <th>Konsumsi Total</th>
                                    <th>Distribusi</th>
                                    <th>Terjual</th>
                                    <th>ATR (%)</th>
                                    <th>Pendapatan</th>
                                </tr>
                            </thead>
                            <tbody id="data-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-title">ðŸ”¥ Heatmap Perbandingan</h2>
                    <div class="heatmap-container">
                        <div class="heatmap">
                            <div class="heatmap-title">Heatmap 1: Pelanggan, Konsumsi & Distribusi</div>
                            <div id="heatmap1" class="heatmap-grid"></div>
                        </div>
                        <div class="heatmap">
                            <div class="heatmap-title">Heatmap 2: Terjual, ATR & Pendapatan</div>
                            <div id="heatmap2" class="heatmap-grid"></div>
                        </div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color status-naik"></div>
                            <span>NAIK (Nilai meningkat)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-turun"></div>
                            <span>TURUN (Nilai menurun)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allData = {};
        let bulanList = [];
        
        // Load Excel file
        async function loadExcel() {
            try {
                const response = await fetch('Data Evaluasi Cabang PDAM.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Filter sheet bulan (bukan "Per Hari")
                bulanList = workbook.SheetNames.filter(name => !name.includes('Per Hari'));
                
                // Baca data dari setiap sheet
                bulanList.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Proses data
                    const processedData = jsonData
                        .filter(row => row.CABANG && row.CABANG !== 'TOTAL')
                        .map(row => {
                            const bulanUpper = sheetName.toUpperCase();
                            
                            // Fungsi untuk membersihkan angka
                            const cleanNumber = (val) => {
                                if (!val || val === '') return 0;
                                if (typeof val === 'string') {
                                    val = val.replace(/,/g, '').replace(/\./g, '');
                                }
                                return parseFloat(val) || 0;
                            };
                            
                            // Cari kolom yang sesuai
                            const pelangganKey = Object.keys(row).find(k => k.includes('JUMLAH PELANGGAN BULAN') && k.toUpperCase().includes(bulanUpper));
                            const konsumsiGol2Key = Object.keys(row).find(k => k.includes('KONSUMSI GOL 2 BULAN') && k.toUpperCase().includes(bulanUpper));
                            const konsumsiTotalKey = Object.keys(row).find(k => k.includes('KONSUMSI TOTAL BULAN') && k.toUpperCase().includes(bulanUpper));
                            const distribusiKey = Object.keys(row).find(k => k.includes('AIR DISTRIBUSI BULAN') && k.toUpperCase().includes(bulanUpper));
                            const terjualKey = Object.keys(row).find(k => k.includes('AIR TERJUAL BULAN') && k.toUpperCase().includes(bulanUpper));
                            const pendapatanKey = Object.keys(row).find(k => k.includes('PENDAPATAN AIR BULAN') && k.toUpperCase().includes(bulanUpper));
                            
                            const pelanggan = cleanNumber(row[pelangganKey]);
                            const konsumsiGol2 = cleanNumber(row[konsumsiGol2Key]);
                            const konsumsiTotal = cleanNumber(row[konsumsiTotalKey]);
                            const distribusi = cleanNumber(row[distribusiKey]);
                            const terjual = cleanNumber(row[terjualKey]);
                            const pendapatan = cleanNumber(row[pendapatanKey]);
                            
                            // Hitung ATR
                            const atr = distribusi > 0 ? ((distribusi - terjual) / distribusi) * 100 : 0;
                            
                            return {
                                cabang: row.CABANG,
                                pelanggan,
                                konsumsiGol2,
                                konsumsiTotal,
                                distribusi,
                                terjual,
                                atr,
                                pendapatan
                            };
                        });
                    
                    allData[sheetName] = processedData;
                });
                
                // Populate dropdown
                populateDropdowns();
                
                // Set default selection
                if (bulanList.length >= 2) {
                    document.getElementById('bulan-sebelum').value = bulanList[0];
                    document.getElementById('bulan-sekarang').value = bulanList[1];
                }
                
                // Update display
                updateDisplay();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-section').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> Tidak dapat memuat file Excel. 
                        Pastikan file "Data Evaluasi Cabang PDAM.xlsx" ada di folder yang sama dengan file HTML ini.
                        <br><br>Detail: ${error.message}
                    </div>
                `;
            }
        }
        
        function populateDropdowns() {
            const select1 = document.getElementById('bulan-sebelum');
            const select2 = document.getElementById('bulan-sekarang');
            
            bulanList.forEach(bulan => {
                const option1 = document.createElement('option');
                option1.value = bulan;
                option1.textContent = bulan;
                select1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = bulan;
                option2.textContent = bulan;
                select2.appendChild(option2);
            });
            
            select1.addEventListener('change', updateDisplay);
            select2.addEventListener('change', updateDisplay);
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(Math.round(num));
        }
        
        function updateDisplay() {
            const bulanSebelum = document.getElementById('bulan-sebelum').value;
            const bulanSekarang = document.getElementById('bulan-sekarang').value;
            
            if (!bulanSebelum || !bulanSekarang) return;
            
            const dataSebelum = allData[bulanSebelum];
            const dataSekarang = allData[bulanSekarang];
            
            if (!dataSebelum || !dataSekarang) return;
            
            // Update table
            updateTable(dataSekarang);
            
            // Update heatmaps
            updateHeatmaps(dataSebelum, dataSekarang);
        }
        
        function updateTable(data) {
            const tbody = document.getElementById('data-tbody');
            tbody.innerHTML = '';
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.cabang}</strong></td>
                    <td class="number">${formatNumber(row.pelanggan)}</td>
                    <td class="number">${formatNumber(row.konsumsiGol2)}</td>
                    <td class="number">${formatNumber(row.konsumsiTotal)}</td>
                    <td class="number">${formatNumber(row.distribusi)}</td>
                    <td class="number">${formatNumber(row.terjual)}</td>
                    <td class="number">${row.atr.toFixed(2)}%</td>
                    <td class="number">Rp ${formatNumber(row.pendapatan)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateHeatmaps(dataSebelum, dataSekarang) {
            // Heatmap 1: Pelanggan, Konsumsi Gol 2, Konsumsi Total, Distribusi
            const metrics1 = [
                { key: 'pelanggan', label: 'Pelanggan' },
                { key: 'konsumsiGol2', label: 'Konsumsi Gol 2' },
                { key: 'konsumsiTotal', label: 'Konsumsi Total' },
                { key: 'distribusi', label: 'Distribusi' }
            ];
            
            // Heatmap 2: Terjual, ATR, Pendapatan
            const metrics2 = [
                { key: 'terjual', label: 'Terjual' },
                { key: 'atr', label: 'ATR (%)' },
                { key: 'pendapatan', label: 'Pendapatan' }
            ];
            
            renderHeatmap('heatmap1', dataSebelum, dataSekarang, metrics1);
            renderHeatmap('heatmap2', dataSebelum, dataSekarang, metrics2);
        }
        
        function renderHeatmap(containerId, dataSebelum, dataSekarang, metrics) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // Header row
            const headerRow = document.createElement('div');
            headerRow.className = 'heatmap-row';
            headerRow.innerHTML = '<div class="heatmap-cell heatmap-header">Cabang</div>';
            metrics.forEach(metric => {
                headerRow.innerHTML += `<div class="heatmap-cell heatmap-header">${metric.label}</div>`;
            });
            container.appendChild(headerRow);
            
            // Data rows
            dataSekarang.forEach(rowSekarang => {
                const rowSebelum = dataSebelum.find(r => r.cabang === rowSekarang.cabang);
                if (!rowSebelum) return;
                
                const dataRow = document.createElement('div');
                dataRow.className = 'heatmap-row';
                dataRow.innerHTML = `<div class="heatmap-cell heatmap-label">${rowSekarang.cabang}</div>`;
                
                metrics.forEach(metric => {
                    const nilaiSebelum = rowSebelum[metric.key];
                    const nilaiSekarang = rowSekarang[metric.key];
                    const status = nilaiSekarang > nilaiSebelum ? 'NAIK' : 'TURUN';
                    const statusClass = status === 'NAIK' ? 'status-naik' : 'status-turun';
                    
                    dataRow.innerHTML += `<div class="heatmap-cell ${statusClass}">${status}</div>`;
                });
                
                container.appendChild(dataRow);
            });
        }
        
        // Load data on page load
        loadExcel();
    </script>
</body>
</html>
